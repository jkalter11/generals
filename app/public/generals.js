/*! generals 2013-11-22 */
!function(){function a(a){n.emit(m.CREATE_GAME,a)}function b(a){a.success?(o.init(a.gameId,a.playerId,a.playerName),o.isCreated=!0,p.showGameView(function(){r.onGameCreated(o)})):s.show(a.error)}function c(){n.emit(m.PLAY_AI,{gameId:o.id,url:window.location.href})}function d(a){n.emit(m.PLAYER_JOIN,a)}function e(a){a.success?o.isCreated?(o.opponentName=a.playerName,r.onPlayerJoined(!0),o.generatePieces(),r.onGamePiecesCreated()):(o.init(a.gameId,a.playerId,a.playerName),o.opponentName=a.opponentName,o.isCreated=!1,p.showGameView(function(){r.onPlayerJoined(!1),o.generatePieces(),r.onGamePiecesCreated()})):s.show(a.error)}function f(a){n.emit(m.SUBMIT_PIECES,a)}function g(a){a.success?(r.onGamePiecesSubmitted(a.playerId,a.positions,a.isStarted),a.isStarted&&(o.isCreated?r.waitPlayersTurn():r.waitForOpponentsTurn())):s.show(a.error)}function h(a){n.emit(m.PIECE_SELECTED,a)}function i(a){r.onOpponentGamePieceSelected(a.position)}function j(a){a.success?r.onGamePieceMovedOrChallenged(a.result,function(){a.isGameOver?r.showGameOver(a):a.playerId==o.playerId?r.waitPlayersTurn():r.waitForOpponentsTurn()}):s.show(a.error)}function k(a){n.emit(m.PLAYER_TAKES_TURN,a)}function l(){s.show("Your opponent has left the game. This game is over.",function(){window.location.href=window.location.href})}var m,n=io.connect(window.location.href),o=TGO.Models.game,p=TGO.Views.mainView,q=TGO.Views.welcomeView,r=TGO.Views.gameView,s=TGO.Views.msgbox;n.on("connected",function(a){m=a,n.on(m.GAME_CREATED,b),n.on(m.PLAYER_JOINED,e),n.on(m.PIECES_SUBMITTED,g),n.on(m.PIECE_SELECTED,i),n.on(m.PLAYER_TAKES_TURN,j),n.on(m.PLAYER_LEFT,l)}),q.on(TGO.Views.Events.CREATE_GAME,a),q.on(TGO.Views.Events.JOIN_GAME,d),r.on(TGO.Views.Events.PLAY_AI,c),r.on(TGO.Views.Events.SUBMIT_PIECES,f),r.on(TGO.Views.Events.GAME_PIECE_SELECTED,h),r.on(TGO.Views.Events.TAKE_TURN,k),p.showWelcomeView()}(),window.TGO={appName:"The Generals Online v0.1.0",Models:{},Views:{},debug:!1},TGO.Models.game={isCreated:!1,opponentName:"Anonymous",pieces:[],init:function(a,b,c){this.id=a,this.playerId=b,this.playerName=c},generatePieces:function(){this.pieces.push({code:"GOA"}),this.pieces.push({code:"SPY"}),this.pieces.push({code:"SPY"}),this.pieces.push({code:"GEN"}),this.pieces.push({code:"LTG"}),this.pieces.push({code:"MAG"}),this.pieces.push({code:"BRG"}),this.pieces.push({code:"COL"}),this.pieces.push({code:"LTC"}),this.pieces.push({code:"MAJ"}),this.pieces.push({code:"CPT"}),this.pieces.push({code:"1LT"}),this.pieces.push({code:"2LT"}),this.pieces.push({code:"SGT"}),this.pieces.push({code:"FLG"});for(var a=0;6>a;a++)this.pieces.push({code:"PVT"});var b=0,c=26;this.isCreated||(b=45,c=71);for(var d=[];c>=b;)d.push(b),b++;for(d.sort(function(){return Math.random()-.5}),a=0,j=this.pieces.length;j>a;a++)this.pieces[a].position=d[a]},getPiece:function(a){for(var b=0,c=this.pieces.length;c>b;b++)if(this.pieces[b].position==a)return this.pieces[b];return null}},TGO.Models.EventEmitter=function(){this._listeners={}},TGO.Models.EventEmitter.prototype={on:function(a,b){this._listeners[a]=b},emit:function(a,b){this._listeners[a]&&this._listeners[a](b||{})}},window.i18n={},window.i18n.load=function(a){$.extend(window.i18n,window.i18n.en(),window.i18n[a]?window.i18n[a]():{}),$("#player-name-header").html(i18n["player-name-header"]),$("#player-name-input").attr("placeholder",i18n["player-name-input-placeholder"]),$(".create-new-game-header").html(i18n["create-new-game-header"]),$(".create-new-game-description").html(i18n["create-new-game-description"]),$("#create-game").html(i18n["create-game-button"]),$(".join-game-header").html(i18n["join-game-header"]),$(".join-game-description").html(i18n["join-game-description"]),$("#game-id-input").attr("placeholder",i18n["game-id-input-placeholder"]),$("#join-game").html(i18n["join-game-button"]),$(".join-game-header").html(i18n["join-game-header"]),$(".game-info-main-header").html(i18n["game-info-main-header"]),$(".game-info-about-header").html(i18n["game-info-about-header"]),$(".game-info-about-description").html(i18n["game-info-about-description"]),$(".game-info-about-online-header").html(i18n["game-info-about-online-header"]),$(".game-info-about-online-description").html(i18n["game-info-about-online-description"]),$("#new-game").html(i18n["new-game-button"]),$("#view-cheat-sheet").html(i18n["view-cheat-sheet-button"]),$("#ready").html(i18n["ready-button"]),$("#play-ai").html(i18n["play-ai-button"]),$(".board-instructions").html(i18n["board-instructions"])},window.i18n.en=function(){return{"player-name-header":"Player Name","player-name-input-placeholder":"type your name/alias here","create-new-game-header":"Create A New Game","create-new-game-description":"Click on the CREATE GAME button and a new game session will be created where you can either play against an AI or play against a human opponent. Just send the game ID generated to your opponent through any chat apps you have.","create-game-button":"CREATE GAME","join-game-header":"Join Existing Game","join-game-description":"If your friend (or opponent) already created a GAME, ask for the GAME ID. If you have the GAME ID of a created GAME SESSION by your friend (or opponent), then you can INPUT that GAME ID in the textbox below and click on the JOIN GAME button.","game-id-input-placeholder":"type the game ID here","join-game-button":"JOIN GAME","game-info-main-header":"Small Introduction","game-info-about-header":"About Game of the Generals","game-info-about-description":"This is a proudly Filipino-invented game by <a href=\"http://en.wikipedia.org/wiki/Special:Search/Sofronio_H._Pasola,_Jr.\"> Sofronio H. Pasola, Jr.</a> in 1970. The game simulates armies at war trying to outflank and outmaneuver each other. The main objective of the game is to eliminate or capture the opponent's FLAG piece or alternatively, bring your own FLAG piece to the opponent's end of the board. This is easy to play. All you have to do is remember who's rank is greater than who (eg: a 5 star general (GOA) is greater than a 3 star (LTG) or 4 star general (GEN) but all these generals and ranked pieces are no match to the spy (SPY) yet the spy (SPY) is no match to the unranked private (PVT)). Intrigued? For more information, here's a <a href=\"http://en.wikipedia.org/wiki/Game_of_the_Generals\">detailed Wikipedia page</a> for this game.","game-info-about-online-header":"About this Online Version of the Game","game-info-about-online-description":'I am not the first to do this. There are versions online about this game (and even an iPhone app - not free) but they are too serious, requires registration and some are NOT FREE. My purpose was just to play the game and then forget about it after. I don\'t need to track each game. This is just for fun. I am not sure if I would eventually make a tournament feature (highly unlikely) but for now, it\'s just play and forget. No ranking, no registration, just pure playing, immediately.<br>Aside from that, this is my first <a href="http://nodejs.org/">Node.js</a> application that I have shared freely online. I made this to familiarize myself more with <a href="http://nodejs.org/">Node.js</a>. This board game is not quite popular in our place and I hope that this application hopes to revive that popularity among Filipino board gamers. This is an easy yet thrilling game. I am sure you will enjoy this game.',"ready-button":"SUBMIT GAME PIECES","new-game-button":"New Game","view-cheat-sheet-button":"View Cheat Sheet","play-ai-button":"PRACTICE FIRST","board-instructions":"<pre>LEFT CLICK:  Select your own game piece\n             Move your own game piece to another square\n             Challenge an opponent's game piece (left click an opponent's game piece)\nRIGHT CLICK: Swap your own game pieces during arranging your own game pieces\n             Alternative to moving your own game piece</pre>"}},TGO.Views.Events={CREATE_GAME:"create-game",PLAY_AI:"play-ai",JOIN_GAME:"join-game",SUBMIT_PIECES:"submit-pieces",GAME_PIECE_SELECTED:"game-piece-selected",TAKE_TURN:"take-turn"},TGO.Views.utils={fadeToView:function(a,b,c){a.fadeOut("fast",function(){a.html(b),a.fadeIn("fast",function(){"function"==typeof c&&c()})})},i18n:function(a){if("string"!=typeof a)return"";a=window.i18n[a]?window.i18n[a]:a;for(var b=1;-1!=a.indexOf("%s")&&b<arguments.length;)a=a.replace("%s",arguments[b]),b++;return a},moveElementAnim:function(a,b,c){if(!a.length)return"function"==typeof c&&c(),void 0;var d=a.offset();a.prependTo(b);var e=a.offset(),f=a.clone().appendTo("body");f.css("position","absolute").css("left",d.left).css("top",d.top).css("zIndex",100),a.hide(),f.animate({top:e.top,left:e.left},"fast",function(){a.show(),f.remove(),"function"==typeof c&&c()})},openSmallWindow:function(a,b){return window.open(a,b,"width=500,height=500,directories=0,titlebar=0,toolbar=0,location=0,status=0,menubar=0,scrollbars=1")}},TGO.Views.msgbox={show:function(a,b){a=TGO.Views.utils.i18n.apply(null,arguments),$.msgbox.show(a,TGO.appName,b)}},TGO.Views.gameView=function(){function a(){w=$(".game-message"),B=$("#game-board");for(var a=$("<tbody></tbody>"),c=0;8>c;c++)a.append("<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");if(B.append(a),D=B.find("td"),TGO.debug){for(C=$("#game-board-numbers"),a=$("<tbody></tbody>"),c=0;8>c;c++)a.append("<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");C.append(a)}x=$("#fallen-pieces"),y=$("#ready"),y.on("click",function(a){a.stopPropagation(),E.emit(TGO.Views.Events.SUBMIT_PIECES,{gameId:F.id,playerId:F.playerId,gamePieces:i()}),A.hide(),y.hide()}),A=$("#play-ai"),A.on("click",function(){E.emit(TGO.Views.Events.PLAY_AI),A.hide(),b("Contacting server for AI player. Please wait..."),J=!0}),z=$("#new-game"),z.on("click",function(a){a.stopPropagation(),window.location.href=window.location.href}),viewCheatSheetButton=$("#view-cheat-sheet"),viewCheatSheetButton.on("click",function(a){a.stopPropagation(),TGO.Views.utils.openSmallWindow("/cs.html","TGO")}),$(document).delegate(".content","click",function(a){a.preventDefault(),G||m()}),B.on("click",function(a){a.stopPropagation(),a.preventDefault(),r($(a.target),!1)}),B.on("contextmenu",function(a){a.stopPropagation(),a.preventDefault(),r($(a.target),!0)}),B.delegate(".game-piece","click",function(a){a.stopPropagation(),a.preventDefault();var b=$(this);b.hasClass("opponent")?r(b.parent(),!1):p($(this))})}function b(a){var b=null,c=Array.prototype.slice.call(arguments,0);"function"==typeof c[c.length-1]&&(b=c.pop()),a=TGO.Views.utils.i18n.apply(null,c),TGO.Views.utils.fadeToView(w,a,b)}function c(){b('WELCOME <span class="highlight">%s</span>! Your game ID is <span class="highlight">%s</span>. Send this to your opponent or if you want to practice, play against an AI.',F.playerName,F.id)}function d(){F.isCreated?b('<span class="highlight">%s</span> connected. ARRANGE your pieces.',F.opponentName):b('WELCOME <span class="highlight">%s</span>! ARRANGE your game pieces.',F.playerName,F.opponentName),A.hide(),y.show(),e()}function e(){var a,b,c,d;if(F.isCreated)for(a=9,b=0,c=0;a>0;)0===b&&(a--,b=9),d=B.find("tr:nth-child("+a+") td:nth-child("+b+")").attr("data-pos",c).data("position",c),TGO.debug&&C.find("tr:nth-child("+a+") td:nth-child("+b+")").html(c),a>5&&d.addClass("initialized"),b--,c++;else for(a=1,b=1,c=0;9>a;)b>9&&(a++,b=1),d=B.find("tr:nth-child("+a+") td:nth-child("+b+")").attr("data-pos",c).data("position",c),TGO.debug&&C.find("tr:nth-child("+a+") td:nth-child("+b+")").html(c),a>5&&d.addClass("initialized"),b++,c++}function f(){for(var a=[],b=0,c=F.pieces.length;c>b;b++)a.push(h(F.pieces[b]));g(a)}function g(a){for(;a.length;){var b=a.pop();B.find('td[data-pos="'+b.data("init-pos")+'"]').append(b),b.removeData("init-pos")}}function h(a){var b=$("<div>");return b.addClass("game-piece"),a.code?(b.addClass("game-piece-"+a.code),b.html('<span class="code">'+a.code+"</span>")):b.addClass("opponent"),b.data("init-pos",a.position),b}function i(){var a=[];return B.find(".game-piece").not(".opponent").each(function(b,c){a.push(F.getPiece($(c).parent().data("pos")))}),a}function j(a,c,d){if(F.playerId==a)b('Game pieces submitted. Waiting for <span class="highlight">%s</span> to submit game pieces.',F.opponentName);else{d||(b('<span class="highlight">%s</span> has submitted game pieces. Submit yours after arranging them.',F.opponentName),y.show());for(var e=[],f=0;f<c.length;f++)e.push(h({position:c[f]}));g(e)}}function k(){b('<span class="highlight">YOUR TURN!</span> Make your move.'),G=!1,I=!0,m()}function l(){b('Waiting for <span class="highlight">%s\'s</span> move. Please wait.',F.opponentName),G=!0,I=!0,J?B.find(".game-piece").not(".opponent").removeClass("selected"):m()}function m(){B.find(".game-piece").removeClass("selected"),D.removeClass("challengeable").removeClass("possible-move"),I&&D.removeClass("initialized")}function n(a){var b=a.parent().data("pos"),c=Math.floor(b/9);o(a,B.find('td[data-pos="'+(b+9)+'"]')),o(a,B.find('td[data-pos="'+(b-9)+'"]')),c==Math.floor((b+1)/9)&&o(a,B.find('td[data-pos="'+(b+1)+'"]')),c==Math.floor((b-1)/9)&&o(a,B.find('td[data-pos="'+(b-1)+'"]'))}function o(a,b){0!==b.length&&(0===b.find(".game-piece").length?b.addClass("possible-move"):a.hasClass("opponent")?b.find(".game-piece").not(".opponent").length&&b.addClass("challengeable"):b.find(".game-piece.opponent").length&&b.addClass("challengeable"))}function p(a){G||H||a.hasClass("opponent")||(m(),a.addClass("selected"),I&&n(a),E.emit(TGO.Views.Events.GAME_PIECE_SELECTED,{gameId:F.id,position:a.parent().data("pos")}))}function q(a){m();var b=B.find('td[data-pos="'+a+'"] .game-piece');b.addClass("selected"),n(b)}function r(a,b){if(!G&&!H){var c=B.find(".game-piece.selected");if(0!==c.length){if(b)for(;"TD"!=a.prop("tagName");)a=a.parent();if(!I||a.hasClass("possible-move")||a.hasClass("challengeable"))if(I)G=!0,E.emit(TGO.Views.Events.TAKE_TURN,{gameId:F.id,playerId:F.playerId,oldPosition:c.parent().data("pos"),newPosition:a.data("pos")});else{if(F.isCreated&&a.data("pos")>26||!F.isCreated&&a.data("pos")<45)return m(),void 0;var d=c.parent(),e=a.find(".game-piece");H=!0;var f=F.getPiece(d.data("pos")),g=F.getPiece(a.data("pos"));f.position=a.data("pos"),g&&(g.position=d.data("pos")),e.length&&d.addClass("target"),a.addClass("target");var h=0;TGO.Views.utils.moveElementAnim(c,a,function(){h++}),TGO.Views.utils.moveElementAnim(e,d,function(){h++}),function i(){2==h?(d.removeClass("target"),a.removeClass("target"),H=!1):setTimeout(i,200)}()}}}}function s(a,b,c){H=!0,b.addClass("target");var d=a.parent().data("pos"),e=b.data("pos");TGO.Views.utils.moveElementAnim(a,b,function(){b.removeClass("target");var a=F.getPiece(d);a&&(a.position=e),H=!1,"function"==typeof c&&c()})}function t(a){var b=TGO.Models.game.getPiece(a.parent().data("pos"));b&&(b.position=-1),a.hasClass("opponent")?(H=!0,a.fadeOut("fast",function(){a.remove(),H=!1})):(H=!0,TGO.Views.utils.moveElementAnim(a,x,function(){a.removeClass("selected"),H=!1}))}function u(a,b){var c=B.find('td[data-pos="'+a.oldPosition+'"] .game-piece'),d=B.find('td[data-pos="'+a.newPosition+'"]');if(a.isChallenge){var e=d.find(".game-piece");1===a.challengeResult?(t(e),s(c,d,b)):0===a.challengeResult?(t(e),t(c),b()):(t(c),s(e,d,b))}else s(c,d,b)}function v(a){a.playerId?a.is50MoveRule?a.playerId==F.playerId?b('<span class="highlight">YOU WIN BY THE 50-MOVE RULE!</span>'):b('<span class="highlight">YOU LOSE BY THE 50-MOVE RULE!</span>'):a.playerId==F.playerId?b('<span class="highlight">YOU WIN!</span>'):b('<span class="highlight">YOU LOSE!</span>'):b('<span class="highlight">THIS GAME IS A DRAW BY THE 50-MOVE RULE!</span>');for(var c=0;c<a.pieces.length;c++)if(-1!=a.pieces[c].position){var d=B.find('td[data-pos="'+a.pieces[c].position+'"] .game-piece.opponent');d.addClass("game-piece-"+a.pieces[c].code),d.html('<span class="code">'+a.pieces[c].code+"</span>")}var e=$(".game-piece.selected");m(),e.length&&(e.addClass("selected"),e.parent().addClass("target")),G=!0}var w,x,y,z,A,B,C,D,E=new TGO.Models.EventEmitter,F=TGO.Models.game,G=!1,H=!1,I=!1,J=!1;return E.init=a,E.onGameCreated=c,E.onPlayerJoined=d,E.onGamePiecesCreated=f,E.onGamePiecesSubmitted=j,E.onOpponentGamePieceSelected=q,E.waitPlayersTurn=k,E.waitForOpponentsTurn=l,E.onGamePieceMovedOrChallenged=u,E.showGameOver=v,E}(),TGO.Views.mainView=function(){function a(a){c(e,"welcome-template",function(){TGO.Views.welcomeView.init(),"function"==typeof a&&a()})}function b(a){c(e,"game-template",function(){TGO.Views.gameView.init(),"function"==typeof a&&(window.i18n.load(f.val()),a())})}function c(a,b,c){var d=$("#"+b).html();TGO.Views.utils.fadeToView(a,d,function(){window.i18n.load(),c()})}var d=new TGO.Models.EventEmitter,e=$(".container .content"),f=$("#language");return f.on("change",function(){window.i18n.load(f.val())}),d.showWelcomeView=a,d.showGameView=b,d}(),TGO.Views.welcomeView=function(){function a(){e=$("#player-name-input"),f=$("#game-id-input"),$("#create-game").on("click",b),$("#join-game").on("click",c),$(".content a, .footer a").attr("target","_blank")}function b(a){a.stopPropagation(),d(e)&&g.emit(TGO.Views.Events.CREATE_GAME,{playerName:e.val()})}function c(a){a.stopPropagation(),d(e,f)&&g.emit(TGO.Views.Events.JOIN_GAME,{playerName:e.val(),gameId:f.val()})}function d(){for(var a=0,b=arguments.length;b>a;a++){var c=arguments[a];if(!c.val()||!c.val())return TGO.Views.msgbox.show("A required field has no value. Click OK and we will focus on that field.",function(){c.focus()}),!1}return!0}var e,f,g=new TGO.Models.EventEmitter;return g.init=a,g}();